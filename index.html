<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Point Pattern Analysis</title>
    <meta charset="utf-8" />
    <meta name="author" content="Martin Hinz" />
    <script src="libs/header-attrs-2.6/header-attrs.js"></script>
    <link rel="stylesheet" href="libs/default.css" type="text/css" />
    <link rel="stylesheet" href="libs/default-fonts.css" type="text/css" />
    <link rel="stylesheet" href="libs/customize.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">

class: title-slide, center, middle


#  Point Pattern Analysis

##  Principles, Methods and Application in R

###  Martin Hinz

####  Institut für Archäologische Wissenschaften, Universität Bern

18.03.2021

.footnote[
.right[
.tiny[
You can find the code and data of this presentation at [https://github.com/MartinHinz/pppa_brno_2021](https://github.com/MartinHinz/pppa_brno_2021).
]
]
]

---
class: inverse, bottom, right
# Introduction and Setting the Frame

---
## Definition

&gt; *Point pattern analysis (PPA) is the study of the spatial arrangements of points in (usually 2-dimensional) space. - wikipedia*

### Centrography
- Measuring the parameters of some point distribution

### Density Analysis
- Visualisation ended up rotation of the density of points

### Distance based Analysis
- Statistical analyses of the distance between points and its distribution

### Modeling
- Modelling spatial processes and comparing the results to actual observed data

---

## Difficulties and tasks

### Get the data
You are responsible.

### Get the data into R
You will see how data needs to be structured to be able to read it into R.

### Using the right tools in the right way
I will demonstrate some tools and their application in special statistics.

### Making the right interpretations and conclusions
You are responsible (again).

---
class: inverse, bottom, right
# Data Preparation and Import

---

## Import formats

### Probably the standard (and worst possible) starting point

- Spreadsheet data 
  - here from our 14C database in development XRONOS
  - sites with 14C data of Czech Republic
  - not very complete... you probably know better sources (for the time being ;-) )

![](images/example_sources.png)
---

### Save as CSV

- CSV: Comma Separated Values
- you can im-/export csv from every spreadsheet software (MS Excel, Libre Office Calc, ...)

![](images/csv_save_excel_libre.png)

---
### CSV vs. 'CSV2'

- two flavours:
  - Anglo-American: comma ',' as column separator, point '.' as decimal separator
  - 'continental': semicolon as column separator, comma ',' as decimal separator
- which one you use depends on your language settings

![](images/csv_differences.png)

---

## Reading csv into R

For reading CSV data into R, you can use the 'read.csv()' function.

Pay attention to use the correct function for your language settings.


```r
 # if you have an anglo-american csv (comma)
data &lt;- read.csv("data/c14sites_comma.csv")
# if you have a continental csv (semicolon)
data &lt;- read.csv2("data/c14sites.csv") 

data
```

```
##                          site     lat     lng
## 1                     Hlinsko 49.7629 15.9095
## 2                  Kutná Hora 49.9474 15.2674
## 3   Mnichovo Hradiště, Dneboh 50.5307 15.0335
## 4      Mohelnice, U cukrovaru 49.7833 16.9167
## 5                     Olomouc 49.5767 17.2311
## 6                   Vedrovice 49.0217 16.3808
## 7               Velké Hoštice 49.9300 17.9600
## 8              Blucina Cezavy 49.0400 16.6200
## 9                      Bylany 49.6667 15.2500
## 10                     Bezděz 50.5342 14.7200
## 11                   Chudeřín 50.3372 13.4470
## 12            Mušov Neurissen 48.9100 16.5640
## 13           Mušov Königsgrab 48.9000 16.5611
## 14               Okrouhlík I. 50.8420 14.3550
## 15           Uhelná rokle II. 50.6053 14.6846
## 16        Orlík-Krkavčí skála 49.5108 14.1653
## 17           Pod Černou Louží 49.5100 15.5130
## 18             Radovesice III 50.4110 14.0683
## 19                    Ďáblice 50.1423 14.4767
## 20              Jenišův Újezd 50.5667 13.7167
## 21             Jezevčí převis 50.7818 14.2145
## 22       Kostelec nad Vltavou 49.5012 14.2109
## 23                     Měšice 50.1969 14.5194
## 24              Okrouhlík II. 50.8420 14.3550
## 25  Radkovice-Osobovská skála 49.4796 13.4580
## 26   Sutny, Těšetice-Kyjovice 48.8960 16.1360
## 27                  Prasklice 49.2688 17.1858
## 28               Slanska Hora 50.2340 14.1000
## 29                    Blučina 49.0550 16.6465
## 30   Miškovice; site: Praha 9 50.1579 14.5454
## 31                  Dluhonice 49.4544 17.4128
## 32                Postoloprty 50.3598 13.7029
## 33                      Becov 50.4339 13.7233
## 34         Zadní Hon, Březník 49.1716 16.1945
## 35              Brno - Bystrc 49.2266 16.5311
## 36                 Brno-Lisen 49.2082 16.6947
## 37        Brodek u Prostějova 49.3701 17.0907
## 38                  Vikletice 50.3500 13.4025
## 39                   Dobešice 49.3268 14.2602
## 40                    Homolka 49.0308 14.9891
## 41                   Denemark 49.9277 15.2528
## 42                   Lovosice 50.5146 14.0515
## 43                  Makotřasy 50.1445 14.2147
## 44                Máselník I. 50.6866 14.5370
## 45                  Mohelnice 49.7833 16.9167
## 46                Nový Bydžov 50.2415 15.4908
## 47 Olomouc-Savonín, Horní lán 49.5767 17.2311
## 48                   Nemilany 49.5585 17.2463
## 49                     Řepčín 49.6079 17.2343
## 50                   Slavonin 49.5700 17.2300
## 51                     Pavlov 48.8742 16.6723
## 52          Pavlov-Horní Pole 48.8745 16.6711
## 53                Pod křídlem 50.6670 14.5328
## 54                      Slany 50.2269 14.0837
## 55   Vlkov u Spáleného-Babiny 49.6029 13.5771
## 56                  Spytihněv 49.1405 17.4982
## 57                   Tušimice 50.3833 13.3667
## 58                  Tvořihráz 48.9172 16.1360
## 59                       Žopy 49.3326 17.6094
## 60                   Heřmánky 49.7069 17.7678
## 61       Otmíče-Otmíčská hora 49.8633 13.9480
## 62                Šídelník I. 50.5700 14.5200
## 63                     Toušeň 50.1695 14.7158
## 64       Mířkov-Racovský vrch 49.5898 12.8798
## 65                Vysoká Lípa 50.8560 14.3480
## 66               Šídelník III 50.5700 14.5200
## 67    Starý zámek, Suchohrdly 48.8683 16.0948
## 68              Na Kocourkách 49.0287 16.4376
## 69                 Slavonín 1 49.5691 17.2348
## 70                 Přáslavice 49.5847 17.3914
## 71           Brno - Ivanovice 49.2641 16.5657
## 72                Černá Louže 50.8556 14.3503
## 73                Chabařovice 50.6732 13.9418
## 74                   Holubice 49.1775 16.8121
## 75                      Hulín 49.3171 17.4639
## 76                  Budkovice 49.0725 16.3462
## 77                   Těšetice 48.8890 16.1581
## 78               Dneboh-Hrada 50.5307 15.0335
## 79                      Mokrá 49.2233 16.7516
## 80               Prag 6, Baba 50.0500 14.4167
## 81                     Donbas 49.4180 17.3108
## 82          Šebkovice, Třebíč 49.1206 15.8198
## 83            Široké Třebčice 50.2807 13.3835
## 84                     Zalany 50.5833 13.9000
```

---

## From data to spatial data

- There are multiple packages for handling spatial data
- Which one to use depends on preferences
- We are using sf here


```r
library(sf)
```

```
## Linking to GEOS 3.8.1, GDAL 3.1.4, PROJ 6.3.1
```

```r
# Convert the dataframe to a spatial object. Note that the
# crs= 4326 parameter assigns a WGS84 coordinate system to the 
# spatial object
data.sf &lt;- st_as_sf(data,
                    coords = c("lng", "lat"), # coordinate columns
                    crs = 4326)  # coordinate references system in epsg
data.sf
```

```
## Simple feature collection with 84 features and 1 field
## geometry type:  POINT
## dimension:      XY
## bbox:           xmin: 12.8798 ymin: 48.8683 xmax: 17.96 ymax: 50.856
## geographic CRS: WGS 84
## First 10 features:
##                         site                geometry
## 1                    Hlinsko POINT (15.9095 49.7629)
## 2                 Kutná Hora POINT (15.2674 49.9474)
## 3  Mnichovo Hradiště, Dneboh POINT (15.0335 50.5307)
## 4     Mohelnice, U cukrovaru POINT (16.9167 49.7833)
## 5                    Olomouc POINT (17.2311 49.5767)
## 6                  Vedrovice POINT (16.3808 49.0217)
## 7              Velké Hoštice     POINT (17.96 49.93)
## 8             Blucina Cezavy     POINT (16.62 49.04)
## 9                     Bylany   POINT (15.25 49.6667)
## 10                    Bezděz   POINT (14.72 50.5342)
```

---

## Mapping the data

.pull-left[
### simple

Just use plot


```r
plot(data.sf)
```

![](index_files/figure-html/unnamed-chunk-9-1.png)&lt;!-- --&gt;
]

.pull-right[
### more elaborated

using the gglot and natural earth data

.tiny[

```r
library(ggplot2)
library(rnaturalearth)

worldmap &lt;- ne_countries(scale = 'medium', type = 'map_units',
                         returnclass = 'sf')
ggplot() + geom_sf(data = worldmap) + geom_sf(data=data.sf) +
    coord_sf(xlim = c(0,40), ylim = c(45,55)) + theme_bw()
```

![](index_files/figure-html/unnamed-chunk-10-1.png)&lt;!-- --&gt;
]]


---

## Problem: lng-lat vs. projection

- Most of the tools for point pattern analyses required distances
- Unprojected coordinate reference systems like the longitude latitude system are not distance correct
- We have to re-project our data

.pull-left[

```r
plot(data.sf, graticule = TRUE)
```

![](index_files/figure-html/unnamed-chunk-11-1.png)&lt;!-- --&gt;
]

.pull-right[

```r
data.utm &lt;- st_transform(data.sf,
                         crs = 32633)
plot(data.utm, graticule = TRUE)
```

![](index_files/figure-html/unnamed-chunk-12-1.png)&lt;!-- --&gt;
]

---

## To come from lng/lat spreadsheat to R spatial data:

### in three simple steps


```r
data &lt;- read.csv2("data/c14sites.csv")
data.sf &lt;- st_as_sf(data,
                    coords = c("lng", "lat"), # coordinate columns
                    crs = 4326)  # coordinate references system in epsg
data.utm &lt;- st_transform(data.sf, crs = 32633)
```

---
class: inverse, bottom, right
# Centrography

---

## Center, standard distance and standard deviational ellipse
.pull-left[
![](images/centrography.svg)
.caption[source: https://mgimond.github.io]
]

.pull-left[
.tiny[

```r
mean_center &lt;- apply(st_coordinates(data.utm),
                     2,
                     mean)

mean_center.df &lt;- as.data.frame(t(mean_center))

mean_center.utm &lt;- st_as_sf(mean_center.df,
                    coords = c("X", "Y"), 
                    crs = 32633)

standard_distance &lt;- mean(
  st_distance(mean_center.utm,
              data.utm))

dx &lt;- sqrt(
  sum(
    (st_coordinates(data.utm)[,1]-
         mean_center[1])^2
    ) / nrow(data.utm)
)

dy &lt;- sqrt(
  sum(
    (st_coordinates(data.utm)[,2]-
       mean_center[2])^2
    ) / nrow(data.utm)
)
```
]
]

---

## Plot Center, standard distance and standard deviational ellipse
.pull-left[
![](images/centrography.svg)
.caption[source: https://mgimond.github.io]
]

.pull-left[
.tiny[

```r
library(aspace)
```

```
## Loading required package: splancs
```

```
## Loading required package: sp
```

```
## 
## Spatial Point Pattern Analysis Code in S-Plus
##  
##  Version 2 - Spatial and Space-Time analysis
```

```
## Loading required package: Hmisc
```

```
## Loading required package: lattice
```

```
## Loading required package: survival
```

```
## Loading required package: Formula
```

```
## 
## Attaching package: 'Hmisc'
```

```
## The following object is masked from 'package:splancs':
## 
##     zoom
```

```
## The following objects are masked from 'package:base':
## 
##     format.pval, units
```

```
## Loading required package: shapefiles
```

```
## Loading required package: foreign
```

```
## 
## Attaching package: 'shapefiles'
```

```
## The following objects are masked from 'package:foreign':
## 
##     read.dbf, write.dbf
```

```r
ellipse &lt;- st_as_sf(calc_sde(points = st_coordinates(data.utm)),
                    coords = c(2,3), 
                    crs = 32633)
```

```
## $id
## [1] 1
## 
## $CALCCENTRE
## [1] TRUE
## 
## $weighted
## [1] FALSE
## 
## $CENTRE.x
## [1] 534995.9
## 
## $CENTRE.y
## [1] 5516291
## 
## $Sigma.x
## [1] 66299.67
## 
## $Sigma.y
## [1] 160162.8
## 
## $Major
## [1] "SigmaY"
## 
## $Minor
## [1] "SigmaX"
## 
## $Theta
## [1] 119.151
## 
## $Eccentricity
## [1] 0.9102988
## 
## $Area.sde
## [1] 33359757635
## 
## $TanTheta
## [1] -1.792892
## 
## $SinTheta
## [1] 0.8733394
## 
## $CosTheta
## [1] -0.4871122
## 
## $SinThetaCosTheta
## [1] -0.4254143
## 
## $Sin2Theta
## [1] 0.7627217
## 
## $Cos2Theta
## [1] 0.2372783
## 
## $ThetaCorr
## [1] 119.151
```

```r
ggplot() + geom_sf(data = worldmap) + geom_sf(data=data.utm) +
  geom_sf(data=mean_center.utm, color="red") +
  geom_sf(data=st_buffer(mean_center.utm, standard_distance), fill="red", alpha = 0.5) +
  geom_sf(data=ellipse, fill="yellow", alpha = 0.5) +
    coord_sf(xlim = c(10,20), ylim = c(48,52)) + theme_bw() 
```

![](index_files/figure-html/unnamed-chunk-15-1.png)&lt;!-- --&gt;
]
]
---
class: inverse, bottom, right
# Density based analysis

---
## Global density

The Density of a pattern in relationship to the overall area.

$$
\widehat{\lambda} = \frac{n}{a}
\label{eq:global-density}
$$


```r
cz.lnglat &lt;- ne_countries(country = 'Czech Republic', returnclass = "sf", scale = "medium")
cz &lt;- st_transform(cz.lnglat, crs = 32633)
cz.area &lt;- st_area(cz)
nrow(data.utm)/cz.area
```

```
## 1.067256e-09 [1/m^2]
```

---
## Local density

The same, but measured at different locations, not only once for all. Which location depends on the approach.
### Quadrat density

Divide the area into squares and calculate the density by square.


```r
library(spatstat)
```

```
## Loading required package: spatstat.data
```

```
## Loading required package: nlme
```

```
## Loading required package: rpart
```

```
## 
## spatstat 1.64-1       (nickname: 'Help you I can, yes!') 
## For an introduction to spatstat, type 'beginner'
```

```
## 
## Note: spatstat version 1.64-1 is out of date by more than 10 months; we recommend upgrading to the latest version.
```

```
## 
## Attaching package: 'spatstat'
```

```
## The following object is masked from 'package:lattice':
## 
##     panel.histogram
```

```r
data.ppp &lt;- as.ppp(data.utm)
marks(data.ppp)  &lt;- NULL

Window(data.ppp) &lt;- as.owin(cz)

plot(data.ppp)
```

![](index_files/figure-html/unnamed-chunk-17-1.png)&lt;!-- --&gt;

```r
#data.ppp &lt;- rescale(data.ppp, 1000, "km")

data.quadcount &lt;- quadratcount(data.ppp, nx= 8, ny=4)

plot(data.quadcount)
```

![](index_files/figure-html/unnamed-chunk-17-2.png)&lt;!-- --&gt;

```r
data.quaddens &lt;- intensity(data.quadcount)

plot(intensity(data.quadcount, image = T))
```

![](index_files/figure-html/unnamed-chunk-17-3.png)&lt;!-- --&gt;

---

### Kernel density

With a cold density estimation we avoid the problems of unequal base sizes resulting from the square. We also avoid arbitrary borders within our investigation area.


```r
data.kde &lt;- density(data.ppp)
plot(data.kde)
contour(data.kde, add=T)
```

![](index_files/figure-html/unnamed-chunk-18-1.png)&lt;!-- --&gt;

Different colour sizes can influence the result of the interpolation.


```r
data.kde2 &lt;- density(data.ppp, sigma = 10000)
plot(data.kde2)
contour(data.kde2, add=T)
```

![](index_files/figure-html/unnamed-chunk-19-1.png)&lt;!-- --&gt;

---
class: inverse, bottom, right
# Distance based analysis

---
## Density vs. Distance

- Investigating how points are distributed in respect to each other (second order property) vs. distributed in respect to the study extend
- reveals more of the mechanics of the process than its relationship to the general space and its features

.pull-left[
![](index_files/figure-html/unnamed-chunk-20-1.png)&lt;!-- --&gt;
]

.pull-right[
![](index_files/figure-html/unnamed-chunk-21-1.png)&lt;!-- --&gt;
]

---
# Density (Point Pattern) Analysis
## Motivation

.pull-left[
* most basically tries to answer the question if data are clustered, regular spaced or random
* uninfluenced spatial processes tend to produce random patterns
* [Complete Spatial Randomness](https://en.wikipedia.org/wiki/Complete_spatial_randomness)
]

.pull-right[
![](images/AM07_Fig3.png)
]
.caption[https://gistbok.ucgis.org/]

---

## Archaeological Motivation

.pull-left[
* clustered patterns result from 'attractive' processes
  * if the presence of one object makes other objects more **likely**
  * eg. burial sites: usually, we have burial grounds/areas, so that burials tend to be clustered in the landscape
* regular patterns result from 'repulsive' processes
  * if the presence of one object makes other objects more **unlikely**
  * eg. settlement sites: usually, settlements need some area/hinterland, so that settlements tend to be more regular in the landscape
]

.pull-right[
![](images/AM07_Fig3.png)
]
.caption[https://gistbok.ucgis.org/]
---

## Distributions of Nearest Neighbor

The distribution of the nearest neighbor differ for different spatial distributions!

.pull-left[
![](index_files/figure-html/unnamed-chunk-22-1.png)&lt;!-- --&gt;
]

.pull-right[
![](index_files/figure-html/unnamed-chunk-23-1.png)&lt;!-- --&gt;
]

---
## The code for that example

.pull-left[
Simulate and plot

.tiny[

```r
library(spatstat)

win &lt;- owin(c(0,10),c(0,10))
set.seed(12)

x &lt;- rnorm(20, 5,1)
set.seed(14)

y &lt;- rnorm(20,5,1)
P.cl &lt;- ppp(x,y,window=win)

P.reg &lt;- rSSI(2, 20, win = win)

P.rnd &lt;- rpoint(20, win=win)

OP &lt;- par(mfrow=c(1,3), mar=c(1,1,1,0))
 plot(P.reg, pch=20, cols=rgb(0,0,0,.5),
      main = "Regular Pattern")
 plot(P.cl, pch=20, cols=rgb(0,0,0,.5), main =
        "Clustered Pattern")
 plot(P.rnd, pch=20, cols=rgb(0,0,0,.5), main =
        "Random Pattern")
par(OP)
```
]]

.pull-right[
Histogram

.tiny[

```r
OP &lt;- par(mfrow=c(1,3), mar=c(1,1,1,0))
hist(nndist(P.reg), xlim=c(0,4), ylim=c(0,20),
     main = "Regular Pattern")
hist(nndist(P.cl), xlim=c(0,4), ylim=c(0,20),
     main = "Clustered Pattern")
hist(nndist(P.rnd), xlim=c(0,4), ylim=c(0,20),
     main = "Random Pattern")
par(OP)
```
]]

---

## Average Nearest Neighbor (ANN)

.pull-left[
**Average Nearest Neighbor (ANN)** measures the average distance of neighboring data points from a given observation. If it is compared with a theoretical random average distance, it tells much about whether data points are clustered or dispersed.

`$$NearestNeighbor Dist ance = d(NN) = \frac{\sum^n_{i=1} min(d_{ij})}{N}$$`
`$$Theoretical Random Distance = d(ran) = 0.5*\sqrt\frac{A}{N}$$`
`\(Nearest Neighbor Index = NNI = \frac{d(NN)}{d(ran)}\)`
]

.pull-right[
![](images/1_ANfLax8UZKlHqyCWK3uR1A.png)
.caption[Average distance of nearest neighbors are shorter in the left. Source: https://towardsdatascience.com]
]

---

## Average Nearest Neighbor (ANN)

.pull-left[
`\(Nearest Neighbor Index = NNI = \frac{d(NN)}{d(ran)}\)`

* if the index is **below** 1, the points tend to be clustered
* if the index is **above** 1, the points tend to be regular
* if the index is **around** 1, the points tend to be random
]

.pull-right[
![](images/NNA.png)
.caption[Average distance of nearest neighbors are shorter in the left. Source: https://towardsdatascience.com]
]

---
## Average Nearest Neighbor (ANN) in R

A simple measurement for the average value of the nearest neighbour of a point pattern 

.pull-left[
![](index_files/figure-html/unnamed-chunk-26-1.png)&lt;!-- --&gt;
]

.pull-right[

```r
mean(nndist(P.reg))
```

```
## [1] 2.119471
```

```r
mean(nndist(P.cl))
```

```
## [1] 0.4333607
```

```r
mean(nndist(P.rnd))
```

```
## [1] 1.180716
```

```r
ann.ran &lt;- 0.5 * sqrt(10*10 / 20)
ann.ran
```

```
## [1] 1.118034
```
]

---
## Average Nearest Neighbor (ANN) for CZ

.pull-left[

```r
data.ann &lt;- mean(nndist(data.ppp))
data.ann
```

```
## [1] 9202.946
```

```r
a_data &lt;- area(as.owin(cz))
n_data &lt;- nrow(data.utm)
ann.ran &lt;- 0.5 * sqrt(a_data/n_data)

data.ann/ann.ran
```

```
## [1] 0.6012999
```
]

.pull-right[
![](images/NNA.png)
.caption[Average distance of nearest neighbors are shorter in the left. Source: https://towardsdatascience.com]
]
---

## Nearest Neighbor Analysis - Restrictions

.pull-left[
- what we consider regular is strongly scale dependend
- also, some processes might be regular in one scale, while clustered in another
- eg. burials around settlements:
  - Settlements might be regular spaced
  - Burials might be clustered around settlements
  - if we have only the burials, in the landscape the might have a similar structure like the example
]

.pull-right[
![](images/NNA05.png)
]

---

## Neighbor Analysis over multiple scales
### The K function

.pull-left[
The **K-Function** (or **Ripley`s K**) measures distances between all points in space rather than just the neighbors as in ANN. It also helps to understand how clustering or dispersion of data occurs in different distances from its center (the centroid).

![:width 60%](images/k_function02.png)
.caption[Statistical significance of Ripley’s K function. Source: https://gistbok.ucgis.org]
]
.pull-right[
![](images/k_function01.png)
.caption[K-Function describing how clustering occurs in different scanning horizon from the center. Source: https://towardsdatascience.com]
]

---

### K Function in R


```r
K &lt;- Kest(data.ppp)
plot(K, main=NULL, las=1, legendargs=list(cex=0.8, xpd=TRUE, inset=c(1.01, 0) ))
```

```
## Warning in min(D[scaledlegbox]): kein nicht-fehlendes Argument für min; gebe Inf
## zurück
```

![](index_files/figure-html/unnamed-chunk-29-1.png)&lt;!-- --&gt;

---

### K Funktion with Envelope


```r
plot(envelope(data.ppp, Kest))
```

```
## Generating 99 simulations of CSR  ...
## 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40,
## 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80,
## 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98,  99.
## 
## Done.
```

![](index_files/figure-html/unnamed-chunk-30-1.png)&lt;!-- --&gt;

---

## inhomogenous point processes

---
## inhomogenous point processes in R


```r
K_in &lt;- Kinhom(data.ppp)

plot(K_in, main = "K function for inhomogenuous point processes")
```

![](index_files/figure-html/unnamed-chunk-31-1.png)&lt;!-- --&gt;

---
## inhomogenous point processes in R with envelope

.pull-left[

```r
lambda &lt;- density.ppp(data.ppp)
plot(lambda)
plot(data.ppp, add=T)
```

![](index_files/figure-html/unnamed-chunk-32-1.png)&lt;!-- --&gt;
]

.pull-right[

```r
Ken &lt;- envelope(data.ppp, 'Kinhom',
                  simulate=expression(rpoispp(lambda)),
                  correction="trans")
```

```
## Generating 99 simulations by evaluating expression  ...
## 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40,
## 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80,
## 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98,  99.
## 
## Done.
```

```r
plot(Ken)
```

![](index_files/figure-html/unnamed-chunk-33-1.png)&lt;!-- --&gt;
]
---
class: inverse, bottom, right
# Covariates
---
## Covariates

---
### Elevation as Covariate
.pull-left[

```r
library(raster)
```

```
## 
## Attaching package: 'raster'
```

```
## The following objects are masked from 'package:spatstat':
## 
##     area, rotate, shift
```

```
## The following object is masked from 'package:nlme':
## 
##     getData
```

```
## The following objects are masked from 'package:Hmisc':
## 
##     mask, zoom
```

```
## The following object is masked from 'package:splancs':
## 
##     zoom
```

```r
library(maptools)
```

```
## Checking rgeos availability: TRUE
```

```
## 
## Attaching package: 'maptools'
```

```
## The following object is masked from 'package:Hmisc':
## 
##     label
```

```r
elev &lt;- raster::getData(name="alt", country = "CZ")
```

```
## Warning in showSRID(uprojargs, format = "PROJ", multiline = "NO", prefer_proj
## = prefer_proj): Discarded datum Unknown based on WGS84 ellipsoid in Proj4
## definition
```

```r
elev.utm &lt;- projectRaster(elev, crs=32633)

elev.im &lt;- as.im.RasterLayer(elev.utm)

plot(elev.im)
```

![](index_files/figure-html/unnamed-chunk-34-1.png)&lt;!-- --&gt;
]

.pull-right[

```r
rho &lt;- rhohat(data.ppp, elev.im,  method="ratio")

plot(rho)
```

![](index_files/figure-html/unnamed-chunk-35-1.png)&lt;!-- --&gt;
]

---

### Compare prediction with ground truth

.pull-left[

```r
pred &lt;- predict(rho)
cl   &lt;- interp.colours(c("lightyellow", "orange" ,"red"), 100) # Create color scheme
plot(pred, col=cl, las=1, main=NULL, gamma = 0.25)
```

![](index_files/figure-html/unnamed-chunk-36-1.png)&lt;!-- --&gt;

```r
plot(data.kde, col=cl, las=1, main=NULL, gamma = 0.25)
```

![](index_files/figure-html/unnamed-chunk-36-2.png)&lt;!-- --&gt;
]

.pull-right[

```r
plot(data.kde, col=cl, las=1, main=NULL, gamma = 0.25)
```

![](index_files/figure-html/unnamed-chunk-37-1.png)&lt;!-- --&gt;
]

---
### Modelling the relationship


```r
# Create the Poisson point process model
PPM1 &lt;- ppm(data.ppp ~ elev.im)
```

```
## Warning: Values of the covariate 'elev.im' were NA or undefined at 0.66% (5
## out of 759) of the quadrature points. Occurred while executing: ppm.ppp(Q =
## data.ppp, trend = ~elev.im, data = NULL, interaction = NULL)
```

```r
# Plot the relationship
plot(effectfun(PPM1, "elev.im", se.fit=TRUE), main=NULL,
     las=1, legendargs=list(cex=0.8, xpd=TRUE, inset=c(1.01, 0) ))
```

```
## Warning in min(D[scaledlegbox]): kein nicht-fehlendes Argument für min; gebe Inf
## zurück
```

![](index_files/figure-html/unnamed-chunk-38-1.png)&lt;!-- --&gt;

---
class: inverse, bottom, right
# Monte Carlo Simulation and Hypothesis tests

---

## Exploring the random range

Remember:


```r
ann.p &lt;- mean(nndist(data.ppp, k=1))
ann.p
```

```
## [1] 9202.946
```


```r
n     &lt;- 100               # Number of simulations
ann.r &lt;- vector(length = n) # Create an empty object to be used to store simulated ANN values
for (i in 1:n){
  rand.p   &lt;- rpoint(n=data.ppp$n, win=cz)  # Generate random point locations
  ann.r[i] &lt;- mean(nndist(rand.p, k=1))  # Tally the ANN values
}
```

---
### homogeneous
.pull-left[

```r
plot(rand.p, pch=16, main=NULL, cols=rgb(0,0,0,0.5))
```

![](index_files/figure-html/unnamed-chunk-41-1.png)&lt;!-- --&gt;
]

.pull-right[

```r
hist(ann.r, main=NULL, las=1, breaks=40, col="bisque", xlim=range(ann.p, ann.r))
abline(v=ann.p, col="blue")
```

![](index_files/figure-html/unnamed-chunk-42-1.png)&lt;!-- --&gt;
]
---

### based on elevation

.pull-left[

```r
plot(elev.im)
```

![](index_files/figure-html/unnamed-chunk-43-1.png)&lt;!-- --&gt;

]
.pull-right[
Invert the Elevation

```r
elev.rescale &lt;- 1- (elev.im- min(elev.im)) /(max(elev.im)-min(elev.im))

plot(elev.rescale)
```

![](index_files/figure-html/unnamed-chunk-44-1.png)&lt;!-- --&gt;
]

---
### Modeling based on Elevation


```r
n     &lt;- 100
ann.r &lt;- vector(length=n)
for (i in 1:n){
  rand.p   &lt;- rpoint(n=data.ppp$n, f=elev.rescale)
  ann.r[i] &lt;- mean(nndist(rand.p, k=1))
}
```

.pull-left[

```r
Window(rand.p) &lt;- as.owin(cz)  # Replace raster mask with ma.km window
plot(rand.p, pch=16, main=NULL, cols=rgb(0,0,0,0.5))
```

![](index_files/figure-html/unnamed-chunk-46-1.png)&lt;!-- --&gt;
]

.pull-right[

```r
hist(ann.r, main=NULL, las=1, breaks=40, col="bisque", xlim=range(ann.p, ann.r))
abline(v=ann.p, col="blue")
```

![](index_files/figure-html/unnamed-chunk-47-1.png)&lt;!-- --&gt;
]

---
### hypothese test
.pull-left[

```r
PPM1
```

```
## Nonstationary Poisson process
## 
## Log intensity:  ~elev.im
## 
## Fitted trend coefficients:
##   (Intercept)       elev.im 
## -17.761354692  -0.008099993 
## 
##                  Estimate        S.E.      CI95.lo       CI95.hi Ztest
## (Intercept) -17.761354692 0.312700862 -18.37423712 -17.148472263   ***
## elev.im      -0.008099993 0.001010436  -0.01008041  -0.006119574   ***
##                   Zval
## (Intercept) -56.799826
## elev.im      -8.016332
## Problem:
##  Values of the covariate 'elev.im' were NA or undefined at 0.66% (5 out of 759) 
## of the quadrature points
```
]

.pull-right[

```r
PPM0 &lt;- ppm(data.ppp ~ 1)
PPM0
```

```
## Stationary Poisson process
## Intensity: 1.067256e-09
##              Estimate      S.E.   CI95.lo   CI95.hi Ztest      Zval
## log(lambda) -20.65818 0.1091089 -20.87202 -20.44433   *** -189.3353
```
]


```r
anova(PPM0, PPM1, test="LRT")
```

```
## Warning: Values of the covariate 'elev.im' were NA or undefined at 0.66% (5
## out of 759) of the quadrature points. Occurred while executing: ppm.ppp(Q =
## data.ppp, trend = ~elev.im, data = NULL, interaction = NULL,
```

```
## Warning: Models were re-fitted after discarding quadrature points that were
## illegal under some of the models
```

```
## Analysis of Deviance Table
## 
## Model 1: ~1 	 Poisson
## Model 2: ~elev.im 	 Poisson
##   Npar Df Deviance  Pr(&gt;Chi)    
## 1    6                          
## 2    7  1   91.731 &lt; 2.2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
```

    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="libs/remark-latest.min.js"></script>
<script src="libs/macros.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false,
"fig_caption": true,
"ratio": "16:10"
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
